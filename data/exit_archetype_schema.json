{
  "schemas": [
    {
      "type_id": "exit.take_profit_stop",
      "schema_version": 1,
      "etag": "W/\"v2.exit.take_profit_stop\"",
      "title": "Take Profit / Stop Loss",
      "summary": "Exit position when TP or SL threshold is reached (ATR or percentage based).",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "tp",
        "sl",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.take_profit_stop.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "tp_sl": {
                "$ref": "common_defs.schema.json#/$defs/TPSLEvent"
              }
            },
            "required": [
              "tp_sl"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action",
          "risk"
        ],
        "additionalProperties": false,
        "allOf": [
          {
            "if": {
              "properties": {
                "event": {
                  "properties": {
                    "tp_sl": {
                      "properties": {
                        "tp_enabled": {
                          "const": true
                        }
                      }
                    }
                  }
                }
              }
            },
            "then": {
              "properties": {
                "risk": {
                  "anyOf": [
                    {
                      "required": ["tp_pct"]
                    },
                    {
                      "required": ["tp_rr"]
                    }
                  ]
                }
              }
            }
          },
          {
            "if": {
              "properties": {
                "event": {
                  "properties": {
                    "tp_sl": {
                      "properties": {
                        "sl_enabled": {
                          "const": true
                        }
                      }
                    }
                  }
                }
              }
            },
            "then": {
              "properties": {
                "risk": {
                  "anyOf": [
                    {
                      "required": ["sl_pct"]
                    },
                    {
                      "required": ["sl_atr"]
                    }
                  ]
                }
              }
            }
          }
        ]
      },
      "constraints": {
        "min_history_bars": 50,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Risk block is REQUIRED. TP and SL levels are defined in risk.tp_rr, risk.tp_pct, risk.sl_atr, or risk.sl_pct. The event.tp_sl block enables/disables TP and SL monitoring. If tp_enabled=true, at least one of tp_rr or tp_pct must be set. If sl_enabled=true, at least one of sl_atr or sl_pct must be set."
      },
      "examples": [
        {
          "human": "BTC 1h: exit long when TP (2:1 RR) or SL (2.0 ATR) is hit",
          "slots": {
            "context": {
              "tf": "1h",
              "symbol": "BTC-USD"
            },
            "event": {
              "tp_sl": {
                "tp_enabled": true,
                "sl_enabled": true
              }
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "tp_rr": 2.0,
              "sl_atr": 2.0
            }
          }
        }
      ],
      "updated_at": "2025-12-02T17:58:21Z"
    },
    {
      "type_id": "exit.trailing_stop",
      "schema_version": 1,
      "etag": "W/\"v2.exit.trailing_stop\"",
      "title": "Trailing Stop",
      "summary": "ATR-based trailing stop that moves with price in favorable direction.",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "trailing",
        "atr",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.trailing_stop.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "trail_band": {
                "$ref": "common_defs.schema.json#/$defs/BandSpec"
              },
              "trail_trigger": {
                "$ref": "common_defs.schema.json#/$defs/BandEvent"
              }
            },
            "required": [
              "trail_band",
              "trail_trigger"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action",
          "risk"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 100,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Risk block is REQUIRED. Trailing stop uses ATR-based band that moves with price. Engine updates the band position as price moves favorably. See BandSpec docs for bars→days conversion. event.trail_band.mult: values >2 are rare, >2.5 are very rare."
      },
      "examples": [
        {
          "human": "ETH 4h: trailing stop using 2.0 ATR band, exit when price crosses below trailing band",
          "slots": {
            "context": {
              "tf": "4h",
              "symbol": "ETH-USD"
            },
            "event": {
              "trail_band": {
                "band": "keltner",
                "length": 20,
                "mult": 2.0
              },
              "trail_trigger": {
                "kind": "edge_event",
                "edge": "lower",
                "op": "cross_out"
              }
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "sl_atr": 2.0
            }
          }
        }
      ],
      "updated_at": "2025-12-02T17:58:21Z"
    },
    {
      "type_id": "exit.time_stop",
      "schema_version": 1,
      "etag": "W/\"v2.exit.time_stop\"",
      "title": "Time-Based Exit",
      "summary": "Exit position after a specified number of bars or time duration.",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "time",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.time_stop.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "time_elapsed": {
                "type": "boolean",
                "const": true
              }
            },
            "required": [
              "time_elapsed"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action",
          "risk"
        ],
        "additionalProperties": false,
        "allOf": [
          {
            "if": {
              "properties": {
                "event": {
                  "properties": {
                    "time_elapsed": {
                      "const": true
                    }
                  }
                }
              }
            },
            "then": {
              "properties": {
                "risk": {
                  "required": ["time_stop_bars"]
                }
              }
            }
          }
        ]
      },
      "constraints": {
        "min_history_bars": 10,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "15m",
          "1h",
          "4h"
        ],
        "notes": "Risk block is REQUIRED. Time duration is specified in risk.time_stop_bars (in BARS, not days). Engine exits when that many bars have elapsed since entry. See RiskSpec docs for bars→days conversion."
      },
      "examples": [
        {
          "human": "BTC 1h: exit long position after 24 bars (24 hours)",
          "slots": {
            "context": {
              "tf": "1h",
              "symbol": "BTC-USD"
            },
            "event": {
              "time_elapsed": true
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "time_stop_bars": 24
            }
          }
        }
      ],
      "updated_at": "2025-12-02T17:58:21Z"
    },
    {
      "type_id": "exit.band_exit",
      "schema_version": 1,
      "etag": "W/\"v2.exit.band_exit\"",
      "title": "Band-Based Exit",
      "summary": "Exit when price touches or crosses a band edge (e.g., opposite band for mean reversion).",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "band",
        "mean-revert",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.band_exit.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "exit_band": {
                "$ref": "common_defs.schema.json#/$defs/BandSpec"
              },
              "exit_trigger": {
                "$ref": "common_defs.schema.json#/$defs/BandEvent"
              }
            },
            "required": [
              "exit_band",
              "exit_trigger"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 50,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Common use: exit long when price touches upper band (mean reversion), or exit short when price touches lower band. See BandSpec docs for bars→days conversion. event.exit_band.mult: values >2 are rare, >2.5 are very rare, >3 are extreme/dramatic."
      },
      "examples": [
        {
          "human": "ETH 1h: exit long when price touches upper Bollinger Band (mean reversion)",
          "slots": {
            "context": {
              "tf": "1h",
              "symbol": "ETH-USD"
            },
            "event": {
              "exit_band": {
                "band": "bollinger",
                "length": 20,
                "mult": 2.0
              },
              "exit_trigger": {
                "kind": "edge_event",
                "edge": "upper",
                "op": "touch"
              }
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "sl_atr": 1.5
            }
          }
        }
      ],
      "updated_at": "2025-12-02T17:58:21Z"
    },
    {
      "type_id": "exit.structure_break",
      "schema_version": 1,
      "etag": "W/\"v2.exit.structure_break\"",
      "title": "Structure Break Exit",
      "summary": "Exit on structure break (breakout in opposite direction indicating trend reversal).",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "breakout",
        "structure",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.structure_break.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "breakout": {
                "$ref": "common_defs.schema.json#/$defs/BreakoutSpec"
              }
            },
            "required": [
              "breakout"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 100,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Exit when price breaks structure in opposite direction (e.g., exit long on breakdown below recent low)."
      },
      "examples": [
        {
          "human": "BTC 4h: exit long when price breaks below 50-bar low (structure break)",
          "slots": {
            "context": {
              "tf": "4h",
              "symbol": "BTC-USD"
            },
            "event": {
              "breakout": {
                "lookback_bars": 50,
                "buffer_bps": 5,
                "confirm": "close_confirm"
              }
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "sl_atr": 2.0
            }
          }
        }
      ],
      "updated_at": "2025-12-02T17:58:21Z"
    },
    {
      "type_id": "exit.squeeze_compression",
      "schema_version": 1,
      "etag": "W/\"v1.exit.squeeze_compression\"",
      "title": "Squeeze Compression Exit",
      "summary": "Exit when volatility compresses back into squeeze (opposite of squeeze expansion entry).",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "volatility",
        "squeeze",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.squeeze_compression.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "squeeze": {
                "$ref": "common_defs.schema.json#/$defs/SqueezeSpec"
              }
            },
            "required": [
              "squeeze"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 100,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Exit when volatility compresses back into squeeze (e.g., BB width pctile drops below threshold). This is the opposite of squeeze expansion entry - exit when the squeeze returns."
      },
      "examples": [
        {
          "human": "ETH 1h: exit long when BB width pctile drops below 10 (squeeze returns)",
          "slots": {
            "context": {
              "tf": "1h",
              "symbol": "ETH-USD"
            },
            "event": {
              "squeeze": {
                "metric": "bb_width_pctile",
                "pctile_min": 10
              }
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "sl_atr": 2.0
            }
          }
        }
      ],
      "updated_at": "2025-12-04T00:00:00Z"
    },
    {
      "type_id": "exit.xs_rank_drop",
      "schema_version": 1,
      "etag": "W/\"v1.exit.xs_rank_drop\"",
      "title": "Cross-Sectional Rank Drop Exit",
      "summary": "Exit position when rank drops below threshold or on rebalance when name falls out of top N.",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "portfolio",
        "momentum",
        "crypto",
        "fx",
        "equity"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.xs_rank_drop.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "type": "object",
            "properties": {},
            "required": [],
            "additionalProperties": false
          },
          "event": {
            "type": "object",
            "properties": {
              "rank_drop": {
                "$ref": "common_defs.schema.json#/$defs/XSRankSpec"
              },
              "exit_on_rebalance": {
                "type": "boolean",
                "description": "Exit position if it falls out of top_n on rebalance"
              },
              "rank_threshold": {
                "type": "integer",
                "minimum": 1,
                "maximum": 200,
                "description": "Exit if rank drops below this threshold (optional, use with exit_on_rebalance=false)"
              }
            },
            "required": [
              "rank_drop"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 100,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1d",
          "1w"
        ],
        "notes": "Special context: empty object (no tf/symbol), same as entry.xs_momentum. Rank is 1-based (1 = highest rank, lower = stronger). Rank drop threshold: exit when name falls below rank N (e.g., rank_threshold=20 means exit when rank > 20). Coupling: event.rank_drop should match entry.xs_momentum.event.rebalance (same universe, rank_feature, rebalance_cadence) for proper coordination. Use exit_on_rebalance=true to exit positions that fall out of top_n on rebalance. Use rank_threshold to exit when rank drops below a specific threshold."
      },
      "examples": [
        {
          "human": "Weekly: exit position if it falls out of top 5 on rebalance",
          "slots": {
            "context": {},
            "event": {
              "rank_drop": {
                "universe": [
                  "BTC-USD",
                  "ETH-USD",
                  "SOL-USD",
                  "ADA-USD"
                ],
                "rank_feature": "ret_1w",
                "top_n": 5,
                "bottom_n": 0,
                "rebalance_cadence": "1w",
                "weights": "equal",
                "side": "long_only"
              },
              "exit_on_rebalance": true
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "time_stop_bars": 30
            }
          }
        }
      ],
      "updated_at": "2025-12-04T00:00:00Z"
    },
    {
      "type_id": "exit.vwap_reversion",
      "schema_version": 1,
      "etag": "W/\"v1.exit.vwap_reversion\"",
      "title": "VWAP Reversion Exit",
      "summary": "Exit when price returns to anchored VWAP (mean reversion target) or moves too far from VWAP.",
      "kind": "exit",
      "tags": [
        "spot",
        "exit",
        "vwap",
        "mean-revert",
        "equity",
        "crypto",
        "fx"
      ],
      "json_schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "./exit.vwap_reversion.schema.json",
        "type": "object",
        "properties": {
          "context": {
            "$ref": "common_defs.schema.json#/$defs/ContextSpec"
          },
          "event": {
            "type": "object",
            "properties": {
              "anchor": {
                "$ref": "common_defs.schema.json#/$defs/VWAPAnchorSpec"
              },
              "dist_sigma_exit": {
                "type": "number",
                "minimum": 0.1,
                "maximum": 10.0,
                "description": "Exit when price distance from VWAP is less than this sigma (mean reversion target)"
              },
              "dist_sigma_stop": {
                "type": "number",
                "minimum": 0.1,
                "maximum": 10.0,
                "description": "Optional: exit when price moves further than this sigma from VWAP (stop loss)"
              }
            },
            "required": [
              "anchor",
              "dist_sigma_exit"
            ],
            "additionalProperties": false
          },
          "action": {
            "$ref": "common_defs.schema.json#/$defs/ExitActionSpec"
          },
          "risk": {
            "$ref": "common_defs.schema.json#/$defs/ExitRiskSpec"
          }
        },
        "required": [
          "context",
          "event",
          "action"
        ],
        "additionalProperties": false
      },
      "constraints": {
        "min_history_bars": 100,
        "pit_safe": true
      },
      "slot_hints": {
        "preferred_tfs": [
          "1h",
          "4h"
        ],
        "notes": "Use dist_sigma_exit to exit when price returns to VWAP (mean reversion target). Optionally use dist_sigma_stop to exit if price moves too far from VWAP."
      },
      "examples": [
        {
          "human": "BTC 1h: exit long when price returns within 0.5σ of AVWAP (YTD)",
          "slots": {
            "context": {
              "tf": "1h",
              "symbol": "BTC-USD"
            },
            "event": {
              "anchor": {
                "anchor": "ytd"
              },
              "dist_sigma_exit": 0.5
            },
            "action": {
              "mode": "close"
            },
            "risk": {
              "sl_atr": 1.5
            }
          }
        }
      ],
      "updated_at": "2025-12-04T00:00:00Z"
    }
  ]
}